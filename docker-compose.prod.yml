version: '3.8'

services:
  # --- Application Layer ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://dv6280.online/api
        NEXT_PUBLIC_WS_URL: wss://dv6280.online/ws
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=https://dv6280.online/api
      - NEXT_PUBLIC_WS_URL=wss://dv6280.online/ws

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: always
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
    environment:
      - PRODUCTION_MODE=true
      - MONGODB_URI=mongodb://mongodb:27017
      - DB_NAME=stormalert
      - REDIS_URL=redis://redis:6379/0
      - ALLOWED_ORIGINS=https://dv6280.online
      - JWT_SECRET=prod_secret_9d8f7a6c5b4e3d2a1f0e9d8c7b6a5f4e3d2a1f0e9d8c
      - KITE_API_KEY=${KITE_API_KEY}
      - KITE_API_SECRET=${KITE_API_SECRET}
    depends_on:
      - mongodb
      - redis

  worker:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: always
    command: python -m backend.workers.notification_worker
    environment:
      - PRODUCTION_MODE=true
      - MONGODB_URI=mongodb://mongodb:27017
      - DB_NAME=stormalert
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET=prod_secret_9d8f7a6c5b4e3d2a1f0e9d8c7b6a5f4e3d2a1f0e9d8c
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - KITE_API_KEY=${KITE_API_KEY}
      - KITE_API_SECRET=${KITE_API_SECRET}
    depends_on:
      - redis
      - mongodb

  # --- Load Balancer ---
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - frontend
      - backend

  # --- Data Layer ---
  mongodb:
    image: mongo:latest
    restart: always
    volumes:
      - mongodb_data:/data/db

  redis:
    image: redis:alpine
    restart: always
    volumes:
      - redis_data:/data

  # --- Observability Stack ---
  prometheus:
    image: prom/prometheus
    volumes:
      - ./infra/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'

  grafana:
    image: grafana/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
      - loki

  loki:
    image: grafana/loki:2.9.0
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./infra/monitoring/loki-config.yaml:/etc/loki/local-config.yaml

  promtail:
    image: grafana/promtail:2.9.0
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers
      - ./infra/monitoring/promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml

  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

volumes:
  mongodb_data:
  redis_data:
